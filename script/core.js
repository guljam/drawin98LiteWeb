const frame=window.requestAnimationFrame,doc=document,isIE=!!doc.documentMode,isEdge=!isIE&&!!window.StyleMedia,isChrome=!(!window.chrome||!window.chrome.webstore&&!window.chrome.runtime),isFirefox="undefined"!=typeof InstallTrigger,god=doc.getElementById("god"),toolBar=doc.getElementById("toolBar"),toolBox=doc.getElementById("toolBox"),penTypeButtonBox=doc.getElementById("penTypeButtonBox"),toolMoveBox=doc.getElementById("toolMoveBox"),toolMoveBoxV=doc.getElementById("toolMoveBoxV"),colorModeButton=doc.getElementById("colorModeButton"),mirrorButton=doc.getElementById("mirrorButton"),penSizeBox=doc.getElementById("penSizeBox"),timerText=doc.getElementById("timerText"),titleFileName=doc.getElementById("titleFileName"),titleFileNameClone=doc.getElementById("titleFileNameClone"),canvasPanel=doc.getElementById("canvasPanel"),canvasPanel2=doc.getElementById("canvasPanel2"),canvas1=doc.getElementById("canvas1"),canvas2=doc.getElementById("canvas2"),canvas4=doc.getElementById("canvas4"),space0=doc.getElementById("space0"),space1=doc.getElementById("space1"),space2=doc.getElementById("space2"),space3=doc.getElementById("space3"),spaceArray=[space0,space1,space2,space3],penTypeRoundBox=doc.getElementById("penTypeRoundBox"),penTypeSquareBox=doc.getElementById("penTypeSquareBox"),colorModeBG=doc.getElementById("colorModeBG"),hintText=doc.getElementById("hintText"),loadButtonInput=doc.getElementById("loadButtonInput"),screenShooter=doc.getElementById("screenShooter"),tempimg=doc.getElementById("tempimg"),tempimg3=doc.getElementById("tempimg3"),colorBar=doc.getElementById("colorBar"),helpPanel=doc.getElementById("helpPanel"),selectModeBox=doc.getElementById("selectModeBox"),selectModeBoxChild=doc.getElementById("selectModeBoxChild"),saveButtonBox=doc.getElementById("saveButtonBox"),tiny=doc.getElementById("tiny"),normalColorBox=doc.getElementById("colorBox"),customColorBox=doc.getElementById("customColorBox"),startupSound=doc.getElementById("startupSound"),recordingPrograss=doc.getElementById("recordingPrograss"),zoominBox=doc.getElementById("zoominBox"),penSizeBoxArray=doc.getElementsByClassName("penSizeBox"),penSizeShapeArray=doc.getElementsByClassName("penSizeShape"),tool2Array=doc.getElementsByClassName("tool2Button"),penSize1gaeArray=doc.getElementsByClassName("penSizeBox"),gkey={q:81,w:87,e:69,y:89,u:85,i:73,a:65,s:83,d:68,f:70,g:71,h:72,j:74,k:75,z:90,x:88,c:67,v:86,b:66,n:78,m:77,r:82,t:84,comma:188,esc:27,n1:49,n2:50,ctrl:17,lalt1:18,lalt:21,shift:16,space:32},c1=canvas1.getContext("2d"),c2=canvas2.getContext("2d"),c4=canvas4.getContext("2d"),desktopColorset=["#96555C","#C57559","#CE945A","#E8BE67","#D6CC7E","#A2B564","#81A254","#5C7F56","#85628E","#6E6F9E","#52608E","#4B779E","#558A9A","#017F7E","#4D8673","#59866C","#9D769E","#AD82A1","#AB99A8","#C7B6BF","#D2CEC9","#C1C0BD","#90908F","#6F6F6F","#4A4A4A","#2C2C2C","#1B1B1B"],toolNumberArr=[0,0,"lineButton2","penButton3","eraseButton4","spuitButton5","handButton6","moveButton7","zoomoutButton8","zoominButton9"],penSizeOddFlag=[1,0,1,1,1,0,1,0,0],penSizeSet=[1,2,3,5,7,10,15,30,100],penSizePreviewRound=[2,3,5,7,11,15,19,23,25],penSizePreviewSquare=[1,2,3,5,7,10,15,19,25],canvasMinHeight=150,canvasMaxHeight=800,rDataLimit=2e7,rImageSaveItv=100;let mainTool=3,canvasClicked=!1,hasCanvasClicked=!1,penSizeIndex=2,penSize=penSizeSet[penSizeIndex],penCapType="round",penJoinType="round",eraseCapType="round",penColor="rgb(0,0,0)",colorModeON=!1,eraseSizeIndex=5,eraseSize=penSizeSet[eraseSizeIndex],lineStartPos=null,canvasWidth=canvas1.clientWidth,canvasHeight=canvas1.clientHeight,mouseMoveUsed=!1,afterPenReturnON=!1,helpON=!1,mirrorON=!1,aboutON=!1,aboutWaitTimer=0,changeCanvasSizeON=!1,topmenuON=!1,spuit1x1Size=6,spuitZoomedSize=60,spuitSlowMoveDist=15,spuitLastX=0,spuitLastY=0,spuitSlowMoveX=0,spuitSlowMoveY=0,handMoveX=0,handMoveY=0,handMoveClickX=0,handMoveClickY=0,imageMoveX=0,imageMoveY=0,imageMoveON=!1,imageMoveClicked=!1,timeCount=0,timerON=!1,timerStartON=!1,timerNextTimer=null,timerLastTime=0,undoImageList=[],undoMirrorList=[],undoLimit=20,undoIndex=null,undoDelFlag=!1,undoStrResetTimer=null,zoomed=1,mainKey=null,subKey=null,loadFileFlag=0,toolBarFloatON=!1,colorBarFloatON=!1,tool1CheckDelayTimer=null,moveEventTime=0,tinyFlag=!1,activeFileMenuEnt=null,colorBarX=0,colorBarY=0,toolBarX=0,toolBarY=0,colorBarSpace=1,toolBarSpace=3,sideSpaceMinHeightTool=420,sideSpaceMinHeightColor=340,spacePreviewList=[0,0,0,0],spacePreviewOFFColor="#EBA6A6",spacePreviewONColor="#A7D8B1",spaceReadyX=0,spaceReadyY=0,spaceReadyIndex=null,godX=0,godY=0,lastInnerWidth=0,zoominBoxX=0,zoominBoxY=0,customColorAddTimer=null,customColorInfo=null,lastZoomBoxX=0,lastZoomBoxY=0,rStartPosX=null,rStartPosY=null,fileNameON=!1,themeON=!1,pointerDownFlag=0;function setGodPosition(){god.style.left=Math.floor(godX)+"px",god.style.top=Math.floor(godY)+"px"}function zoomBoxMoveFunc(e){9!==mainTool&&doc.removeEventListener("pointermove",zoomBoxMoveFunc);const o=getCanvasCursorPos(e);lastZoomBoxX=o.x,lastZoomBoxY=o.y,zoomBoxMove()}function pointerMoveFunc(e){const o=e.timeStamp;if(o-moveEventTime<3)return;switch(pointerDownFlag){case 1:return godX+=e.movementX,godY+=e.movementY,void setGodPosition();case 2:return void moveSpeedCursor(e.pageX);case 3:return void moveTimeCursor(e.pageX,Math.abs(e.movementX));case 4:{const o=window["space"+toolBarSpace];if(toolBarSpace>=2){const t=o.clientHeight-toolBar.clientHeight;(toolBarY+=e.movementY)<=0?toolBarY=0:toolBarY>=t&&(toolBarY=t),toolBar.style.top=toolBarY+"px"}else{const t=o.clientWidth-toolBar.clientWidth;(toolBarX+=e.movementX)<=0?toolBarX=0:toolBarX>=t&&(toolBarX=t),toolBar.style.left=toolBarX+"px"}return void checkSpaceReady(e.x,e.y)}case 5:{const o=window["space"+colorBarSpace];if(colorBarSpace>=2){const t=o.clientHeight-colorBar.clientWidth;(colorBarY+=e.movementY)<0?colorBarY=0:colorBarY>t&&(colorBarY=t),colorBar.style.top=colorBarY+"px"}else{const t=o.clientWidth-colorBar.clientWidth;(colorBarX+=e.movementX)<0?colorBarX=0:colorBarX>t&&(colorBarX=t),colorBar.style.left=colorBarX+"px"}return void checkSpaceReady(e.x,e.y)}case 6:return(canvasHeight+=e.movementY)>canvasMaxHeight?canvasHeight=canvasMaxHeight:canvasHeight<canvasMinHeight&&(canvasHeight=canvasMinHeight),void(e.movementY&&chCanvasPreview(canvasHeight))}if(7===mainTool&&!0===imageMoveClicked)return imageMoveX+=e.movementX/zoomed,imageMoveY+=e.movementY/zoomed,c1.save(),c1.globalAlpha=1,c1.clearRect(0,0,canvasWidth,canvasMaxHeight),c1.translate(imageMoveX,imageMoveY),c1.drawImage(canvas2,0,0),void c1.restore();if(!1===canvasClicked)return;moveEventTime=o,mouseMoveUsed=!0;const t=getCanvasCursorPos(e),a=t.x,n=t.y;switch(mainTool){case 2:{const e=penSizeOddFlag[penSizeIndex],o=1===e?a:a+.5,t=1===e?n:n+.5;c1.beginPath(),c1.moveTo(lineStartPos.x,lineStartPos.y),c1.lineTo(o,t),c1.clearRect(0,0,canvasWidth,canvasMaxHeight),c1.stroke();break}case 3:c1.lineTo(a,n),c1.clearRect(0,0,canvasWidth,canvasMaxHeight),c1.stroke();break;case 4:{const e=penSizeOddFlag[eraseSizeIndex],o=1===e?a:a+.5,t=1===e?n:n+.5;c1.lineTo(o,t),c1.clearRect(0,0,canvasWidth,canvasMaxHeight),c1.stroke();break}case 5:{const e=Math.abs,o=Math.sign,t=a-spuitLastX,i=n-spuitLastY,l=o(t),r=o(i),s=Math.ceil(spuitSlowMoveDist/zoomed*2);e(t)>s?(l<0?spuitSlowMoveX-=1:l>0&&(spuitSlowMoveX+=1),spuitZoom(spuitSlowMoveX,spuitSlowMoveY),spuitLastX=a,spuitLastY=n):e(i)>s&&(r<0?spuitSlowMoveY-=1:r>0&&(spuitSlowMoveY+=1),spuitZoom(spuitSlowMoveX,spuitSlowMoveY),spuitLastX=a,spuitLastY=n);break}case 6:handMoveX+=e.pageX-handMoveClickX,handMoveY+=e.pageY-handMoveClickY,handMoveClickX=e.pageX,handMoveClickY=e.pageY,canvasPanel2.offsetLeft===handMoveX&&canvasPanel2.offsetTop===handMoveY||(canvasPanel2.style.left=handMoveX+"px",canvasPanel2.style.top=handMoveY+"px")}}function removeCustomColorZIndex(){customColorBox.style.zIndex="",normalColorBox.addEventListener("pointerover",addCustomColorZIndex),normalColorBox.removeEventListener("pointerleave",removeCustomColorZIndex)}function addCustomColorZIndex(){customColorBox.style.zIndex=-1,normalColorBox.addEventListener("pointerleave",removeCustomColorZIndex),normalColorBox.removeEventListener("pointerover",addCustomColorZIndex)}function setDesktopColor(e){if(!e)return;const o=rgbStringToRGBArr(e),t=o[0],a=o[1],n=o[2],i=t<=190&&a<=190&&n<=190?"rgb(255,255,255)":"rgb(0,0,0)";document.documentElement.style.setProperty("--desktopColor",e),document.documentElement.style.setProperty("--desktopFontColor",i),(isChrome||isFirefox)&&localStorage.setItem("desktopColor",e)}function timerStartFunc(e){const o=e.target.id;"canvas1"!==o&&"canvasPanel"!==o||(timerStartON=!0,timerLastTime=Date.now(),timerNextTimer=setTimeout(timerGO,1e3),doc.removeEventListener("pointerdown",timerStartFunc))}function checkTitleFocus(e){"titleFileName"!==e.target.id&&(fileNameON=!1,titleFileName.setSelectionRange(0,0),titleFileName.blur(),doc.removeEventListener("pointerdown",checkTitleFocus))}function drawDot(e,o,t,a,n,i){let l=a.toLowerCase(),r=n/2;"round"===l?(e.beginPath(),e.save(),e.fillStyle=i,e.arc(o,t,r,0,6.48),e.fill(),e.restore()):("square"===l||n<2)&&(e.beginPath(),e.save(),e.fillStyle=i,e.rect(o-r,t-r,n,n),e.fill(),e.restore())}function fileLoad(e){undoImageList=[],undoMirrorList=[],undoIndex=null,tempimg.removeAttribute("src"),tempimg.src="";const o=loadButtonInput.files[0].name.split(".");let t="",a=0;for(let e=0,a=o.length-1;e<a;++e)t+=o[e];titleFileNameClone.textContent=t,(a=titleFileNameClone.offsetWidth)<10?a=10:a>300&&(a=300),titleFileName.value=t,titleFileName.style.width=a+"px",c1.globalAlpha=1,c1.clearRect(0,0,canvasWidth,canvasMaxHeight),c2.globalAlpha=1,c2.clearRect(0,0,canvasWidth,canvasMaxHeight),c4.globalAlpha=1,c4.clearRect(0,0,canvasWidth,canvasMaxHeight),tempimg.onload=function(){tempimg.style.display="block";let e=Math.min(Math.max(150,tempimg.offsetHeight),800);tempimg.style.display="none",chCanvas(e),checkToolPosition(),c2.drawImage(tempimg,0,0),addUndo()},checkCanvasSize(),tempimg.src=-1!==e.target.result.indexOf("data:")?e.target.result:"",loadButtonInput.value=""}function zoomOut(){const e=zoomed,o=canvasWidth/2-canvasPanel2.offsetLeft,t=canvasHeight/2-canvasPanel2.offsetTop;if(--zoomed<1&&(zoomed=1),zoomCanvas(zoomed),e<=2)return;const a=zoomed/e,n=canvasPanel2.offsetLeft-(o*a-o)>>0,i=canvasPanel2.offsetTop-(t*a-t)>>0;canvasPanel2.style.left=n+"px",canvasPanel2.style.top=i+"px",9===mainTool&&(zoominBox.style.display="block")}function zoomIn(){const e=zoomed,o=zoominBoxX*e,t=zoominBoxY*e;if(++zoomed>4&&(zoomed=4),zoomCanvas(zoomed),e>=4)return;const a=zoomed/e,n=-(o*a>>0),i=-(t*a>>0);canvasPanel2.style.left=n+"px",canvasPanel2.style.top=i+"px",zoomBoxMove()}function zoomBoxMove(){if(zoomed>=4)return void(zoominBox.style.display="none");const e=(zoomed+1>4?4:zoomed+1)/zoomed;zoominBox.style.width=(canvasWidth/zoomed/e>>0)+"px",zoominBox.style.height=(canvasHeight/zoomed/e>>0)+"px";const o=lastZoomBoxX-zoominBox.offsetWidth/2>>0,t=lastZoomBoxY-zoominBox.offsetHeight/2>>0;zoominBoxX=o,zoominBoxY=t,zoominBox.style.transform="translate("+o+"px,"+t+"px)"}function zoominBoxSwitch(e){!1===e?(zoominBox.style.display="none",zoominBox.classList.remove("zoominCursorON")):!0===e&&(zoominBox.style.display="block",printHint("Select zoom position. (Key : W or U)"),zoominBox.classList.add("zoominCursorON"),zoomBoxMove())}function checkGodPosition(){const e=god.getBoundingClientRect(),o=.8*-e.width,t=window.innerHeight;e.top<=0?godY=0:e.top>.8*t&&(godY-=e.top-.8*t),e.left<o?godX=o:e.right>window.innerWidth-o&&(godX-=e.right-(window.innerWidth-o)),setGodPosition()}function aboutOFF(){aboutON=!1;const e=doc.getElementById("aboutPanel"),o=doc.getElementById("aboutImg"),t=doc.getElementById("titleText");clearInterval(aboutWaitTimer),startupSound.pause(),startupSound.currentTime=0,e.style.display="none",o.style.transform="",t.classList.remove("aboutLoading"),chCanvasPreview(canvasHeight),canvasPanel.style.transition="",o.style.transform="scale(1)",checkToolPosition()}function spuitToolReady(){c4.save(),c4.globalAlpha=1,c4.fillStyle="#FFFFFF",c4.fillRect(0,0,canvasWidth,canvasMaxHeight),c4.fill(),c4.drawImage(canvas2,0,0),c4.restore()}function checkSpaceSize(){const e=spaceArray,o=e.length;e[toolBarSpace].style.width=toolBar.offsetWidth+8+"px",e[colorBarSpace].style.width="50px";for(let t=0;t<o;++t)if(e[t].style.display="block",e[t].style.opacity="1",e[t].style.backgroundColor="",e[t].style.border="",t>=2){const o=canvasPanel.offsetHeight+space0.offsetHeight+space1.offsetHeight+10;let a=o;toolBarSpace>=2&&o<sideSpaceMinHeightTool?a=sideSpaceMinHeightTool:colorBarSpace>=2&&o<sideSpaceMinHeightColor&&(a=sideSpaceMinHeightColor),0===e[t].childElementCount&&(e[t].style.width="0px"),e[t].style.height=(a>>0)+"px",e[t].style.top="0px"}else e[t].style.width="100%",e[t].style.height="",e[t].style.top="0px";checkGodWidth()}function spaceReadyCancel(){canvasPanel.style.borderColor=""}function checkSpaceReady(e,o){const t=canvasPanel.getBoundingClientRect(),a=t.left,n=t.right,i=t.top,l=t.bottom,r=[0,0,0,0];let s=null;for(let t=spacePreviewList.length-1;t>=0;--t)1===spacePreviewList[t]?r[t]=spacePreviewOFFColor:r[t]="transparent",0!==spacePreviewList[t]&&(0===t&&e>=a&&e<=n&&o>=l-20-10&&o<=l+10?(s=t,r[t]=spacePreviewONColor,spaceReadyX=e-a,spaceReadyY=0):1===t&&e>=a&&e<=n&&o>=i-10&&o<=i+20+10?(s=t,r[t]=spacePreviewONColor,spaceReadyX=e-a,spaceReadyY=0):2===t&&e>=n-20-10&&e<=n+10&&o>=i&&o<=l?(s=t,r[t]=spacePreviewONColor,spaceReadyX=0,spaceReadyY=o-i):3===t&&e>=a-10&&e<=a+20+10&&o>=i&&o<=l&&(s=t,r[t]=spacePreviewONColor,spaceReadyX=0,spaceReadyY=o-i));spaceReadyIndex=s,canvasPanel.style.borderColor=r[1]+" "+r[2]+" "+r[0]+" "+r[3]}function spacePreview(){const e=spaceArray.length;let o=[0,0,0,0];spaceReadyIndex=null,spacePreviewList=[0,0,0,0];for(let t=0;t<e;++t)t===colorBarSpace||t===toolBarSpace?(spacePreviewList[t]=0,o[t]="transparent"):(spacePreviewList[t]=1,o[t]=spacePreviewOFFColor);canvasPanel.style.borderColor=o[1]+" "+o[2]+" "+o[0]+" "+o[3]}function setToolSpace(e){if(toolBarSpace=e,toolBar.style.left="0px",toolBar.style.top="0px",toolBarX=spaceReadyX,toolBarY=spaceReadyY,god.style.width=god.offsetWidth+50+"px",toolBar.style.left=toolBarX+"px",toolBar.style.top=toolBarY+"px",e>=2){toolMoveBoxV.style.display="none",toolMoveBox.style.display="block",toolBar.style.margin="0px 5px",toolBar.style.flexDirection="",toolBar.style.justifyContent="",toolBar.style.width="",toolBar.style.marginBottom="",toolBox.style.width="",toolBox.style.height="",toolBox.style.marginLeft="0px",toolMoveBox.style.transform="",toolMoveBox.style.width="",penTypeButtonBox.style.marginTop="",penTypeButtonBox.style.height="",penTypeButtonBox.style.width="",penTypeButtonBox.style.flexWrap="",penTypeButtonBox.style.padding="",penTypeButtonBox.style.marginRight="",penSizeBox.style.width="",penSizeBox.style.padding="";const e=penSize1gaeArray.length;for(let o=0;o<e;++o)penSize1gaeArray[o].style.padding="",penSize1gaeArray[o].style.minWidth="",penSize1gaeArray[o].style.minHeight="",penSize1gaeArray[o].style.height="",penSize1gaeArray[o].style.width="100%";penSizeCursorSelect(penSizeIndex)}else{toolMoveBoxV.style.display="block",toolMoveBox.style.display="none",toolBar.style.margin="0px",toolBar.style.flexDirection="row",toolBar.style.justifyContent="flex-start",toolBar.style.width="570px",toolBar.style.margin="0px 0px 3px 0px",toolBox.style.height="27px",toolBox.style.marginLeft="0px",toolMoveBox.style.transform="rotate(90deg)",toolMoveBox.style.width="25px",penTypeButtonBox.style.marginTop="0px",penTypeButtonBox.style.height="28px",penTypeButtonBox.style.width="85px",penTypeButtonBox.style.flexWrap="wrap",penTypeButtonBox.style.padding="0px",penTypeButtonBox.style.marginRight="5px",penSizeBox.style.width="205px",penSizeBox.style.padding="0px";const e=penSize1gaeArray.length;for(let o=0;o<e;++o)penSize1gaeArray[o].style.padding="0px 3px",penSize1gaeArray[o].style.minWidth="10px",penSize1gaeArray[o].style.minHeight="25px",penSize1gaeArray[o].style.height="100%",penSize1gaeArray[o].style.width="initial",penSize1gaeArray[o].firstChild.offsetHeight;penSizeCursorSelect(penSizeIndex)}const o=window["space"+e],t=doc.createDocumentFragment();0!==e&&1!==e||(o.style.top=""),t.appendChild(toolBar),o.appendChild(t),changePenType(4===mainTool?eraseCapType:penCapType),checkSpaceSize()}function setColorBarSpace(e){colorBarSpace=e,colorBar.style.top="0px",colorBar.style.left="0px",colorBarX=spaceReadyX,colorBarY=spaceReadyY,colorBar.style.left=colorBarX+"px",colorBar.style.top=colorBarY+"px",e>=2?(colorBar.style.transform="rotate(90deg) scaleY(-1)",colorBar.style.marginLeft="4px",colorBar.style.marginBottom="",colorModeBG.style.transform="rotate(-90deg) scaleX(-1)"):(colorBar.style.transform="",colorBar.style.marginLeft="",colorBar.style.marginBottom="",colorModeBG.style.transform="");const o=window["space"+e],t=doc.createDocumentFragment();if(t.appendChild(colorBar),o.appendChild(t),0===e||1===e)o.style.top="";else if(2===e||3===e){const e=colorBar.clientHeight+colorBar.clientLeft+parseInt(colorBar.style.marginLeft)+2;o.style.width=e+"px"}checkSpaceSize()}function rgbStringToRGBArr(e){if(""===e||e.indexOf("rgb")<0)return 0;const o=/[^0-9]/g,t=e.split(",");return[Number(t[0].replace(o,"")),Number(t[1].replace(o,"")),Number(t[2].replace(o,""))]}function Tool234Hint(){let e=3===mainTool?"Pen ":4===mainTool?"Erase ":2===mainTool?"Straight line ":0;printHint(0!==e?e:"")}function changeColorBGButton(e){if(!0===colorModeON){const o=rgbStringToRGBArr(e),t=(255+o[0])/2,a=(255+o[1])/2,n=(255+o[2])/2;colorModeBG.style.color=t<=190&&a<=190&&n<=190?"rgb(255,255,255)":"rgb(0,0,0)",colorModeBG.textContent="50%",colorModeBG.style.backgroundColor="rgb("+t+","+a+","+n+")"}else colorModeBG.style.backgroundColor=e,colorModeBG.textContent=""}function changeColorMode(){!0===(colorModeON=!colorModeON)?(colorModeButton.style.borderColor="#A0A0A0 white white #A0A0A0",changeColorBGButton(penColor)):!1===colorModeON&&(colorModeButton.style.borderColor="white #A0A0A0 #A0A0A0 white",changeColorBGButton(penColor))}function saveData(e){if(!1===e){c1.save(),c1.globalAlpha=1,c1.fillStyle="white",c1.fillRect(0,0,canvasWidth,canvasMaxHeight),c1.fill(),c1.drawImage(canvas2,0,0),c1.restore();const e=titleFileName.value+".png";if(isEdge){const o=canvas1.msToBlob();window.navigator.msSaveBlob(o,e)}else screenShooter.href=canvas1.toDataURL("image/png").replace("image/png","image/octet-stream"),screenShooter.setAttribute("download",e),screenShooter.click();c1.clearRect(0,0,canvasWidth,canvasMaxHeight)}else!0===e&&saveReplay()}function clearAll(){confirm("Clear canvas?")&&(tempimg.removeAttribute("src"),undoImageList=[],undoMirrorList=[],undoIndex=null,mirrorON=!1,mirrorButton.classList.remove("tool2ButtonON"),titleFileName.value="Untitled",titleFileNameClone.textContent="Untitled",titleFileName.style.width=titleFileNameClone.offsetWidth+"px",c1.globalAlpha=1,c1.clearRect(0,0,canvasWidth,canvasMaxHeight),c2.globalAlpha=1,c2.clearRect(0,0,canvasWidth,canvasMaxHeight),c4.globalAlpha=1,c4.clearRect(0,0,canvasWidth,canvasMaxHeight),checkCanvasSize(),addUndo())}function printHint(e){hintText.textContent=e}function checkToolPosition(){if(!0===helpON||!0===aboutON)return;const e=toolBarSpace,o=colorBarSpace,t=window.innerHeight,a=window.scrollY,n=window["space"+e],i=window["space"+o],l=n.clientWidth-toolBar.clientWidth,r=n.clientHeight-toolBar.clientHeight,s=i.clientWidth-colorBar.clientWidth,c=i.clientHeight-colorBar.clientWidth;if(toolBarY<=0?toolBarY=0:toolBarY>=r&&(toolBarY=r),toolBarX<=0?toolBarX=0:toolBarX>=l&&(toolBarX=l),colorBarY<=0?colorBarY=0:colorBarY>=c&&(colorBarY=c),colorBarX<=0?colorBarX=0:colorBarX>=s&&(colorBarX=s),toolBar.style.left=toolBarX+"px",toolBar.style.top=toolBarY+"px",colorBar.style.left=colorBarX+"px",colorBar.style.top=colorBarY+"px",e>=1){const o=toolBarY,n=(1===e?space1:2===e?space2:space3).offsetTop+o,i=n+toolBar.clientHeight+godY;if(n<a){let e=o+(a-n-1);toolBarFloatON=!0,toolBar.style.top=e+"px"}else if(i>t+a){let e=o-(i-(t+a));e<0&&(e=0),toolBarFloatON=!0,toolBar.style.top=e+"px"}else toolBarFloatON=!1,toolBar.style.top=toolBarY+"px"}else{const e=space0.offsetTop+toolBar.clientHeight+godY;if(e>t+a){let o=-(e-(t+a));toolBarFloatON=!0,toolBar.style.top=o+"px"}else toolBarFloatON=!1,toolBar.style.top="0px"}if(o>=1){const e=colorBarY,n=(1===o?space1:2===o?space2:space3).offsetTop+e+1,i=n+(o>=2?colorBar.clientWidth:colorBar.clientHeight)+godY;if(n<a){let o=e+(a-n);colorBarFloatON=!0,colorBar.style.top=o+"px"}else if(i>t+a){let o=e-(i-(t+a));o<0&&(o=0),colorBarFloatON=!0,colorBar.style.top=o+"px"}else colorBarFloatON=!1,colorBar.style.top=colorBarY+"px"}else{const e=space0.offsetTop+colorBar.clientHeight+godY;if(e>t+a){let o=-(e-(t+a));colorBarFloatON=!0,colorBar.style.top=o+"px"}else colorBarFloatON=!1,colorBar.style.top="0px"}}function checkGodWidth(){const e=space2.offsetWidth+space3.offsetWidth+canvasPanel.offsetWidth+5>>0;god.style.width=e+"px"}function checkCanvasSize(){canvasPanel.style.width="600px",canvasPanel.style.borderColor="",canvas1.style.display="",canvas2.style.display="",canvas4.style.display="none",saveButtonBox.style.display="block",canvas1.height=canvasHeight,canvasPanel.style.height=canvasHeight+"px",canvasPanel2.style.height=canvasHeight+"px",checkSpaceSize(),checkToolPosition()}function canvasPanelMoveLimit(){const e=canvasPanel.getBoundingClientRect(),o=canvasPanel2.getBoundingClientRect();o.right<e.left?canvasPanel2.style.left=-.8*o.width+"px":o.left>e.right&&(canvasPanel2.style.left=.8*e.width+"px"),o.bottom<e.top?canvasPanel2.style.top=-.8*o.height+"px":o.top>e.bottom&&(canvasPanel2.style.top=.8*e.height+"px"),handMoveX=canvasPanel2.offsetLeft,handMoveY=canvasPanel2.offsetTop}function zoomCanvas(e){canvasPanel2.style.transform="scale("+e+")",1==e?(canvasPanel2.style.left="0px",canvasPanel2.style.top="0px",handMoveX=0,handMoveY=0):canvasPanelMoveLimit(),e>1&&printHint("Zoom x"+e)}function penSizeCursorSelect(e){const o=penSizeBoxArray.length;for(let t=0;t<o;++t){const o=penSizeBoxArray[t];e===t?(o.classList.add("penSizeBoxSelected"),o.firstElementChild.classList.add("penSizeSelected"),8===t&&(doc.getElementById("penSizeText8").style.color="black")):(o.classList.remove("penSizeBoxSelected"),o.firstElementChild.classList.remove("penSizeSelected"),8===t&&(doc.getElementById("penSizeText8").style.color="white"))}}function tool2CursorSelect(e){const o=tool2Array.length;for(let t=0;t<o;++t){const o=tool2Array[t];o.id===e?o.classList.add("tool2ButtonON"):o.classList.remove("tool2ButtonON")}3===mainTool||4===mainTool||2===mainTool?(penSizeBox.style.opacity="",penSizeBox.classList.remove("noHover"),penTypeButtonBox.style.opacity="",penTypeButtonBox.classList.remove("noHover")):(penSizeBox.style.opacity="0.3",penSizeBox.classList.add("noHover"),penTypeButtonBox.style.opacity="0.3",penTypeButtonBox.classList.add("noHover"))}function getCanvasCursorPos(e){if("canvas1"===e.target.id){return{x:e.offsetX,y:e.offsetY}}if("canvasPanel1"===e.target.id){return{x:e.offsetX-20,y:e.offsetY-20}}{const o=canvasPanel2.getBoundingClientRect();return{x:(e.pageX-o.left-window.scrollX)/zoomed,y:(e.pageY-o.top-window.scrollY)/zoomed}}}function afterUndo(e){mirrorON!==undoMirrorList[e]&&(c2.save(),c2.globalAlpha=1,c2.globalCompositeOperation="copy",c2.scale(-1,1),c2.drawImage(canvas2,0,0,-canvasWidth,canvasMaxHeight),c2.restore()),imageMoveON=!1,imageMoveX=0,imageMoveY=0;const o=undoLimit;let t=" ";for(let e=0;e<o;++e)t+=e<undoIndex?"▮":"▯";return clearTimeout(undoStrResetTimer),undoStrResetTimer=setTimeout(function(){Tool234Hint()},2e3),t}function redo(){const e=undoImageList.length-1;null!==undoIndex&&(undoIndex!==e?(undoIndex+=1,c2.putImageData(undoImageList[undoIndex],0,0),printHint(afterUndo(undoIndex)+" Redo (Key : X or M)")):undoDelFlag=!1)}function undo(){if(null===undoIndex&&(undoIndex=undoImageList.length-1),undoDelFlag=!0,(undoIndex-=1)<0)return void(undoIndex=0);c2.putImageData(undoImageList[undoIndex],0,0),printHint(afterUndo(undoIndex)+" Undo (Key : Z or ,)")}function addUndo(){!0===undoDelFlag&&(undoDelFlag=!1,undoImageList.splice(undoIndex+1),undoMirrorList.splice(undoIndex+1)),undoImageList.push(c2.getImageData(0,0,canvasWidth,canvasMaxHeight)),undoMirrorList.push(mirrorON),undoImageList.length>undoLimit+1&&(undoImageList.splice(0,1),undoMirrorList.splice(0,1)),undoIndex=undoImageList.length-1}function timerGO(){const e=Date.now();timeCount+=.001*(e-timerLastTime),timerLastTime=e;const o=Math.floor,t=o(timeCount/3600),a=o((timeCount-3600*t)/60),n=o(timeCount%60),i=(t<10?"0"+t:t)+":"+(a<10?"0"+a:a)+":"+(n<10?"0"+n:n),l=o(timeCount);timerNextTimer=setTimeout(timerGO,1e3),timerText.textContent=i,l>0&&l%3600==0&&(timerText.classList.add("buttonShake"),setTimeout(function(){timerText.classList.remove("buttonShake")},3e3))}function mirrorCanvas(){!0===(mirrorON=!mirrorON)?mirrorButton.classList.add("tool2ButtonON"):!1===mirrorON&&mirrorButton.classList.remove("tool2ButtonON"),c2.save(),c2.globalAlpha=1,c2.globalCompositeOperation="copy",c2.scale(-1,1),c2.drawImage(canvas2,0,0,-canvasWidth,canvasMaxHeight),c2.restore();const e=canvasWidth/2,o=canvasPanel2.offsetLeft+canvasPanel2.offsetWidth*zoomed/2,t=canvasPanel2.offsetLeft+2*(e-o);canvasPanel2.style.left=t+"px",7===mainTool&&(imageMoveON=!1,imageMoveX=0,imageMoveY=0),printHint("Flip-canvas Horizontal (Key : A or K)")}function changePenSize(e){if(!0===e){const e=penSizeSet.length-1;3===mainTool||2===mainTool?(++penSizeIndex>e&&(penSizeIndex=e),penSize=penSizeSet[penSizeIndex],penSizeCursorSelect(penSizeIndex)):4===mainTool&&(++eraseSizeIndex>e&&(eraseSizeIndex=e),eraseSize=penSizeSet[eraseSizeIndex],penSizeCursorSelect(eraseSizeIndex))}else 3===mainTool||2===mainTool?(--penSizeIndex<0&&(penSizeIndex=0),penSize=penSizeSet[penSizeIndex],penSizeCursorSelect(penSizeIndex)):4===mainTool&&(--eraseSizeIndex<0&&(eraseSizeIndex=0),eraseSize=penSizeSet[eraseSizeIndex],penSizeCursorSelect(eraseSizeIndex))}function changePenType(e){if(!(mainTool>4))if("square"===e){penTypeSquareBox.style.border="1px solid #0A246A",penTypeRoundBox.style.border="1px solid transparent";for(let e=0,o=penSizeShapeArray.length;e<o;++e)toolBarSpace>=2?(penSizeShapeArray[e].style.width="25px",penSizeShapeArray[e].style.height=penSizePreviewSquare[e]+"px",penSizeShapeArray[e].style.borderRadius="0%"):(penSizeShapeArray[e].style.width=penSizePreviewSquare[e]+"px",penSizeShapeArray[e].style.height="25px",penSizeShapeArray[e].style.borderRadius="0%")}else if("round"===e){penTypeRoundBox.style.border="1px solid #0A246A",penTypeSquareBox.style.border="1px solid transparent";for(let e=0,o=penSizeShapeArray.length;e<o;++e){let o=penSizePreviewRound[e];penSizeShapeArray[e].style.width=o+"px",penSizeShapeArray[e].style.height=o+"px",penSizeShapeArray[e].style.borderRadius="50%"}}}function NumberFromString(e){return e&&"object"!=typeof e?"number"==typeof e?e:Number(e.replace(/\D/g,"")):""}function spuitZoom(e,o){const t=c4.getImageData(e,o,1,1).data,a=spuit1x1Size,n=spuitZoomedSize,i=n/a,l=a/2+1;let r="red";const s=zoomed>1?n/zoomed*2:n/zoomed;t[0]>150&&t[1]<t[0]&&t[2]<t[0]&&(r="#00FFFF"),c1.save(),c1.globalAlpha=1,c1.imageSmoothingEnabled=!1,c1.webkitImageSmoothingEnabled=!1,c1.msImageSmoothingEnabled=!1,c1.fillStyle="white",c1.fillRect(0,0,canvasWidth,canvasMaxHeight),c1.fill(),c1.drawImage(canvas2,e-a,o-a,3*a,3*a,e-n-l,o-n-l,3*n,3*n),c1.beginPath(),c1.lineWidth=1,c1.strokeStyle="red",c1.globalCompositeOperation="destination-in",c1.arc(e,o,s,0,6.48),c1.fill(),c1.globalCompositeOperation="source-over",c1.beginPath(),c1.lineWidth=1===zoomed?2:1,c1.strokeStyle=r,c1.rect(e-l,o-l,i,i),c1.stroke(),c1.restore();const c=t[3]/255,d=Math.round,p=d((1-c)*t[0]+c*t[0]),m=d((1-c)*t[1]+c*t[1]),u=d((1-c)*t[2]+c*t[2]),y="rgb("+p+","+m+","+u+")";0===p&&0===m&&0===u&&0===c?(penColor="rgb(255,255,255,1)",changeColorBGButton("rgb(255,255,255,1)")):(penColor=y,changeColorBGButton(y))}function chCanvasPreview(e){canvasPanel.style.height=e+"px",printHint("Canvas size "+canvasWidth+" x "+e)}function chCanvas(e){canvas1.height=e,canvasPanel.style.height=e+"px",canvasPanel.style.borderColor="",canvasPanel2.style.height=e+"px",canvasHeight=e;const o=canvasPanel.offsetHeight+space0.offsetHeight+space1.offsetHeight+10;let t=o;toolBarSpace>=2&&o<sideSpaceMinHeightTool?t=sideSpaceMinHeightTool:colorBarSpace>=2&&o<sideSpaceMinHeightColor&&(t=sideSpaceMinHeightColor),space2.style.height=t+"px",space3.style.height=t+"px";const a=colorBarY+colorBar.clientWidth,n=toolBarY+toolBar.clientHeight;if(colorBarSpace>=2&&a>t){colorBarY-=a-t,colorBar.style.top=colorBarY+"px"}if(toolBarSpace>=2&&n>t){toolBarY-=n-t,toolBar.style.top=toolBarY+"px"}canvasPanelMoveLimit()}doc.getElementById("body").onload=function(){canvasPanel2.style.width=canvasWidth+"px",canvasPanel2.style.height=canvasHeight+"px",canvas1.height=canvasHeight,canvas2.height=canvasMaxHeight,canvas4.height=canvasMaxHeight,changeColorBGButton(penColor),penTypeRoundBox.style.border="1px solid #0A246A",penTypeSquareBox.style.border="1px solid transparent",space2.style.height=canvasHeight+"px",space3.style.height=canvasHeight+"px",godX=window.innerWidth/2-god.offsetWidth/2,godY=50,setGodPosition(),lastInnerWidth=window.innerWidth;for(let e=0,o=penSizeShapeArray.length;e<o;++e){const o=penSizeShapeArray[e];let t=penSizePreviewRound[e];o.style.width=t+"px",o.style.height=t+"px"}const e=doc.createDocumentFragment();for(let o=0,t=desktopColorset.length;o<t;++o){let t=doc.createElement("div");t.classList.add("desktopColorBox"),t.style.backgroundColor=desktopColorset[o],e.appendChild(t)}if(doc.getElementById("desktopColorPicker").appendChild(e),isChrome||isFirefox){const e=localStorage.getItem("desktopColor");e&&setDesktopColor(e)}addCustomColorZIndex(),zoomCanvas(zoomed),addUndo(),checkCanvasSize(),checkToolPosition(),penSizeCursorSelect(penSizeIndex),tool2CursorSelect("penButton3"),checkGodPosition(),checkGodWidth(),titleFileNameClone.textContent=titleFileName.value,titleFileName.style.width=titleFileNameClone.offsetWidth+"px"},doc.addEventListener("pointerdown",function(e){if(0!==e.button)return!1;if(!0===aboutON){if("c301"===e.target.id)return;return void aboutOFF()}const o=e.target||e.srcElement,t=o.id,a=o.classList;if(doc.addEventListener("pointermove",pointerMoveFunc),a.contains("titleClick")&&!1===fileNameON)pointerDownFlag=1;else{if(null!==activeFileMenuEnt){if(a.contains("saveButton"))saveData(!1);else if(a.contains("saveReplayImageButton"))saveReplayCurrentImage();else{if(a.contains("loadButton"))return loadFileFlag=0,void loadButtonInput.click();if("loadButtonInput"===t)return void(loadFileFlag=0);a.contains("resetButton")&&clearAll()}return topmenuON=!1,activeFileMenuEnt.style.display="none",void(activeFileMenuEnt=null)}if("menuFile"===t&&0==topmenuON){if(topmenuON=!0,null===activeFileMenuEnt){const e=o.firstElementChild;activeFileMenuEnt=e,e.style.display="block"}return}if("menuTimer"===t)return void(!1===timerON?(timerON=!0,timerText.style.display="block",timerText.textContent="00:00:00",doc.addEventListener("pointerdown",timerStartFunc)):!0===timerON&&(timerON=!1,timerStartON=!1,timeCount=0,timerText.style.display="none",doc.removeEventListener("pointerdown",timerStartFunc),clearTimeout(timerNextTimer)));if("menuAbout"===t){const e=doc.getElementById("aboutPanel"),o=doc.getElementById("aboutImg"),t=doc.getElementById("titleText");return startupSound.play(),aboutON=!0,helpON=!1,helpPanel.style.display="none",e.style.display="block",t.classList.add("aboutLoading"),chCanvasPreview(390),toolBar.style.top="0px",colorBar.style.top="0px",void(aboutWaitTimer=setInterval(function(){startupSound.currentTime>1.2&&(clearInterval(aboutWaitTimer),o.style.transform="scale(3)",canvasPanel.style.transition="1.85s",chCanvasPreview(canvasMaxHeight))},100))}if("menuHelp"===t||"iconSomething"===t)return void(!0===(helpON=!helpON)?helpPanel.style.display="block":!1===helpON&&(helpPanel.style.display="none"));if(a.contains("drawin98Click"))"none"===god.style.display?(god.style.display="block",checkGodPosition()):(themeON=!1,doc.getElementById("desktopColorPanel").style.display="none",god.style.display="none",rePlayPause());else{if(a.contains("themeClick")){themeON=!0;const e=doc.getElementById("desktopColorPanel");return e.style.display="block",e.style.left=window.innerWidth/2-e.offsetWidth/2+"px",void(e.style.top=window.innerHeight/2-e.offsetHeight/2+"px")}if(a.contains("desktopColorBox"))return void setDesktopColor(o.style.backgroundColor);if(!0===themeON&&"desktopColorPicker"!==t&&"desktopColorPanel"!==t&&!a.contains("desktopColorBox"))return themeON=!1,void(doc.getElementById("desktopColorPanel").style.display="none")}}if(9===mainTool&&"zoominBox"===t)zoomIn();else if("canvas1"===t||"canvasPanel"===t)if(5===mainTool){const o=getCanvasCursorPos(e),t=o.x>>0,a=o.y>>0;canvasClicked=!0,spuitLastX=t,spuitLastY=a,spuitSlowMoveX=t,spuitSlowMoveY=a,spuitZoom(t,a)}else if(6===mainTool)canvasClicked=!0,handMoveClickX=e.pageX,handMoveClickY=e.pageY;else if(7===mainTool)canvasClicked=!0,!1===imageMoveON&&(imageMoveON=!0),imageMoveClicked=!0,imageMoveX=0,imageMoveY=0,c1.save(),c1.globalAlpha=1,c1.globalCompositeOperation="copy",c1.translate(imageMoveX,imageMoveY),c1.drawImage(canvas2,0,0),c1.restore(),canvas2.style.opacity="0";else{const o=getCanvasCursorPos(e),t=o.x,a=o.y;if(mouseMoveUsed=!1,canvasClicked=!0,hasCanvasClicked=!0,c1.beginPath(),c1.lineWidth=4===mainTool?0===eraseSizeIndex?1.01:eraseSize:0===penSizeIndex?1.01:penSize,c1.lineCap=4===mainTool?eraseCapType:penCapType,c1.lineJoin=penJoinType,c1.strokeStyle=4===mainTool?"#FFFFFF":penColor,c1.globalAlpha=!0===colorModeON&&4!==mainTool?.5:1,3===mainTool||4===mainTool){const e=penSizeOddFlag[3===mainTool?penSizeIndex:eraseSizeIndex],o=1===e?t:t+.5,n=1===e?a:a+.5;penSmoothX=o,penSmoothY=n,c1.moveTo(o,n)}else if(2===mainTool){const e=penSizeOddFlag[penSizeIndex];lineStartPos={x:1===e?t:t+.5,y:1===e?a:a+.5}}}else if(a.contains("mirrorClick"))mirrorCanvas();else if(null===mainKey&&a.contains("tool2Click")){let e=NumberFromString(t);switch(e>1&&8!==e&&(mainTool=e,9!==e&&zoominBoxSwitch(!1),a.contains("icon2")?tool2CursorSelect(o.parentElement.id):tool2CursorSelect(o.id)),e){case 0:undo();break;case 1:redo();break;case 2:penSize=penSizeSet[penSizeIndex],penSizeCursorSelect(penSizeIndex),changePenType(penCapType),printHint("Straight line. (Key : SHIFT)");break;case 3:penSize=penSizeSet[penSizeIndex],penSizeCursorSelect(penSizeIndex),changePenType(penCapType),Tool234Hint();break;case 4:eraseSize=penSizeSet[eraseSizeIndex],penSizeCursorSelect(eraseSizeIndex),changePenType(eraseCapType),printHint("Erase. (Key : D or H)");break;case 5:spuitToolReady(),printHint("Select color. Drag to move by 1 pixel. (Key : C or N)");break;case 6:printHint("Move canvas. Press zoom-out button to reset canvas position. (Key : SPACEBAR)");break;case 7:canvas1.style.opacity="1",printHint("Move canvas image. If image is outside the canvas, it will be erased. (Key : V or B)");break;case 9:zoominBoxSwitch(!0),doc.addEventListener("pointermove",zoomBoxMoveFunc);break;case 8:zoomOut(),printHint("Zoom x"+zoomed+" (Key : S or J)")}}else if(a.contains("penSizeClick")){const e=NumberFromString(t);3===mainTool||2===mainTool?(penSize=penSizeSet[e],penSizeIndex=e,penSizeCursorSelect(e)):4===mainTool&&(eraseSize=penSizeSet[e],eraseSizeIndex=e,penSizeCursorSelect(e))}else if(a.contains("customColor")&&null===customColorAddTimer){const e=getComputedStyle(o).getPropertyValue("background-color");customColorInfo=[o,e],customColorAddTimer=setTimeout(function(){o.style.backgroundColor=penColor,customColorAddTimer=null},500)}else if(a.contains("penColorBox")){const e=o.style.backgroundColor;if(penColor===e)return;penColor=e,changeColorBGButton(e)}else a.contains("colorModeClick")?changeColorMode():a.contains("penTypeRound")?(4===mainTool?eraseCapType="round":penCapType="round",changePenType("round")):a.contains("penTypeSquare")?(4===mainTool?eraseCapType="square":penCapType="square",changePenType("square")):a.contains("canvasSize")?(canvasPanel.style.borderColor="#B2B2B2",pointerDownFlag=6,changeCanvasSizeON=!0):a.contains("colorMoveClick")?(pointerDownFlag=5,colorBarSpace>=2&&!0===colorBarFloatON&&(colorBarY=colorBar.offsetTop,colorBar.style.top=colorBarY+"px"),spacePreview()):a.contains("toolMoveClick")&&(pointerDownFlag=4,toolBarSpace>=2&&!0===toolBarFloatON&&(toolBarY=toolBar.offsetTop,toolBar.style.top=toolBarY+"px"),spacePreview())}),doc.addEventListener("pointerup",function(e){if(!0!==aboutON){switch(doc.removeEventListener("pointermove",pointerMoveFunc),canvasClicked=!1,pointerDownFlag){case 1:checkGodPosition(),checkToolPosition();break;case 4:case 5:null!==spaceReadyIndex&&(5===pointerDownFlag?setColorBarSpace(spaceReadyIndex):setToolSpace(spaceReadyIndex),spaceReadyIndex=null),spaceReadyCancel(),checkToolPosition();break;case 6:chCanvas(canvasPanel.clientHeight),changeCanvasSizeON=!1,checkToolPosition()}if(0!==pointerDownFlag&&(pointerDownFlag=0),null!==customColorAddTimer){const o=e.target||e.srcElement;if(clearTimeout(customColorAddTimer),customColorAddTimer=null,o.classList.contains("customColor")){const e=customColorInfo[1];penColor=e,changeColorBGButton(e)}}if(7===mainTool)0!==imageMoveX||0!==imageMoveY?(imageMoveClicked=!1,canvas1.style.opacity="1",c2.save(),c2.globalCompositeOperation="copy",c2.drawImage(canvas1,0,0),c2.restore(),c1.clearRect(0,0,canvasWidth,canvasMaxHeight),addUndo(),imageMoveX=0,imageMoveY=0):c1.clearRect(0,0,canvasWidth,canvasMaxHeight),canvas2.style.opacity="";else if(5===mainTool){const o=e.target.id;c1.clearRect(0,0,canvasWidth,canvasMaxHeight),c1.beginPath(),"iconSpuit5"!==o&&"spuitButton5"!==o&&mainKey!==gkey.c&&mainKey!==gkey.n&&(mainTool=3,penSize=penSizeSet[penSizeIndex],penSizeCursorSelect(penSizeIndex),tool2CursorSelect(toolNumberArr[3]),changePenType(penCapType))}else if(6===mainTool)handMoveX=canvasPanel2.offsetLeft,handMoveY=canvasPanel2.offsetTop,canvasPanelMoveLimit();else if(!0===hasCanvasClicked&&mainTool<=4){hasCanvasClicked=!1;const o=getCanvasCursorPos(e),t=penSizeOddFlag[4===mainTool?eraseSizeIndex:penSizeIndex],a=1===t?o.x:o.x+.5,n=1===t?o.y:o.y+.5;if(!1===mouseMoveUsed)c1.clearRect(0,0,canvasWidth,canvasMaxHeight),drawDot(c1,a,n,c1.lineCap,c1.lineWidth,c1.strokeStyle),4===mainTool?(c2.save(),c2.globalCompositeOperation="destination-out",c2.drawImage(canvas1,0,0),c2.restore()):c2.drawImage(canvas1,0,0),c1.clearRect(0,0,canvasWidth,canvasMaxHeight),c1.beginPath(),addUndo();else switch(mainTool){case 2:c1.beginPath(),c1.moveTo(lineStartPos.x,lineStartPos.y),c1.lineTo(a,n),c1.clearRect(0,0,canvasWidth,canvasMaxHeight),c1.stroke(),c2.drawImage(canvas1,0,0),c1.clearRect(0,0,canvasWidth,canvasMaxHeight),addUndo(),lineStartPos=null;break;case 3:c1.lineTo(a,n),c1.clearRect(0,0,canvasWidth,canvasMaxHeight),c1.stroke(),c2.drawImage(canvas1,0,0),c1.clearRect(0,0,canvasWidth,canvasMaxHeight),addUndo();break;case 4:c1.lineTo(a,n),c1.clearRect(0,0,canvasWidth,canvasMaxHeight),c1.stroke(),c2.save(),c2.globalCompositeOperation="destination-out",c2.drawImage(canvas1,0,0),c2.restore(),c1.clearRect(0,0,canvasWidth,canvasMaxHeight),addUndo()}}!0===afterPenReturnON&&(afterPenReturnON=!1,5===mainTool&&c1.clearRect(0,0,canvasWidth,canvasMaxHeight),mainTool=3,penSize=penSizeSet[penSizeIndex],penSizeCursorSelect(penSizeIndex),tool2CursorSelect(toolNumberArr[3]),changePenType(penCapType),mainKey=null,subKey=null),hasCanvasClicked=!1,mouseMoveUsed=!1}}),doc.addEventListener("pointerover",function(e){if(5===pointerDownFlag||!0===aboutON||null!==mainKey)return;const o=e.target||e.srcElement,t=o.classList,a=o.id;if(!0!==topmenuON)if("canvas1"===a&&mainTool<=4&&Tool234Hint(!1),"tiny"===a)printHint("Click to use tiny cursor in canvas.");else if("recordinglimitBar"===a){printHint("Current recording progress "+(rDataCounter/2e7*100).toFixed(1)+"%. If it is 100%, will save and re-recording")}else if(t.contains("canvasSize")&&!1===changeCanvasSizeON)printHint("Drag to change canvas size.");else if(t.contains("colorModeClick"))printHint("Click to toggle between 50% - 100% opacity (Key : E or Y)");else if(t.contains("penSizeBox")){const e=penSizeSet[NumberFromString(a)];printHint((3===mainTool?"Pen":4===mainTool?"Erase":"Line")+" size : "+e+"px (Key : F or G)")}else t.contains("penTypeClick")?printHint("Line shape. (Key : Q or I)"):t.contains("grabBox")?printHint("Click to move."):t.contains("penColorBox")?printHint("Click to select color."):t.contains("customColor")&&printHint("Click to select color. Long-click to add current color.");else t.contains("saveButton")?printHint("Save image as *.png file. (Key : CTRL+S)"):t.contains("loadButton")?printHint("load image."):t.contains("resetButton")&&printHint("Click to clear canvas (Key : ESC)")}),doc.onkeypress=function(e){if(!0===fileNameON)return;let o=e.keyCode||e.which;if(!1===canvasClicked){if(32===o)return e.preventDefault(),!1;if(116===o)return e.preventDefault(),!1;if(9===o||32===o||112===o)return e.preventDefault(),!1}},doc.addEventListener("keydown",function(e){let o=e.keyCode||e.which;if(!0===fileNameON)return;if(e.ctrlKey){switch(o){case gkey.s:return saveData(!1),e.preventDefault(),!1}return e.preventDefault(),!1}if(e.shiftKey){switch(o){case gkey.s:saveData(!0),e.preventDefault()}e.preventDefault()}else o===gkey.esc&&clearAll();if(4===pointerDownFlag||5===pointerDownFlag)return;let t=!1;if(4===mainTool&&null===subKey&&(o===gkey.f?(changePenSize(!1),subKey=o):o===gkey.g?(changePenSize(!0),subKey=o):o===gkey.q&&(t=!0,"round"===eraseCapType?eraseCapType="square":"square"===eraseCapType&&(eraseCapType="round"),changePenType(eraseCapType),subKey=o)),!0!==canvasClicked&&null===mainKey)switch(o===gkey.w&&o===gkey.u||zoominBoxSwitch(!1),o){case gkey.f:mainKey=o,changePenSize(!1);break;case gkey.g:mainKey=o,changePenSize(!0);break;case gkey.q:case gkey.i:!1===t&&(mainKey=o,4===mainTool?("square"===eraseCapType?eraseCapType="round":"round"===eraseCapType&&(eraseCapType="square"),changePenType(eraseCapType)):("square"===penCapType?penCapType="round":"round"===penCapType&&(penCapType="square"),changePenType(penCapType)));break;case gkey.e:case gkey.y:mainKey=o,changeColorMode();break;case gkey.a:case gkey.k:mainKey=o,mirrorCanvas();break;case gkey.z:case gkey.comma:mainKey=o,undo(),tool2Array.undoButton0.classList.add("tool2ButtonON");break;case gkey.x:case gkey.m:mainKey=o,redo(),tool2Array.redoButton1.classList.add("tool2ButtonON");break;case gkey.shift:mainKey=o,mainTool=2,penSize=penSizeSet[penSizeIndex],Tool234Hint(!1),penSizeCursorSelect(penSizeIndex),tool2CursorSelect(toolNumberArr[2]),changePenType(penCapType);break;case gkey.d:case gkey.h:mainKey=o,mainTool=4,penSize=penSizeSet[eraseSizeIndex],Tool234Hint(!1),penSizeCursorSelect(eraseSizeIndex),tool2CursorSelect(toolNumberArr[4]),changePenType(eraseCapType);break;case gkey.v:case gkey.b:mainKey=o,mainTool=7,tool2CursorSelect(toolNumberArr[7]),printHint("Move canvas image. If image is outside the canvas, it will be erased.");break;case gkey.c:case gkey.n:mainKey=o,spuitToolReady(),mainTool=5,tool2CursorSelect(toolNumberArr[5]),printHint("Select color. Click+Drag to moving by 1 pixel.");break;case gkey.space:mainKey=o,mainTool=6,handMoveX=canvasPanel2.offsetLeft,handMoveY=canvasPanel2.offsetTop,tool2CursorSelect(toolNumberArr[6]),printHint("Move canvas. Press zoom-out button to reset canvas position.");break;case gkey.w:case gkey.u:mainKey=o,mainTool=9,tool2CursorSelect(toolNumberArr[9]),zoominBoxSwitch(!0),doc.addEventListener("pointermove",zoomBoxMoveFunc);break;case gkey.s:case gkey.j:mainKey=o,tool2CursorSelect(toolNumberArr[8]),zoomOut()}}),doc.addEventListener("keyup",function(e){if(5===pointerDownFlag)return;const o=e.keyCode||e.which;if(null===subKey||o!==gkey.f&&o!==gkey.g&&o!==gkey.q||(subKey=null),!0!==canvasClicked||3===mainTool||o!==mainKey){if(o===mainKey)switch(o===mainKey&&(mainKey=null),o!==gkey.w&&o!==gkey.u||zoominBoxSwitch(!1),o===gkey.z||o===gkey.comma?tool2Array.undoButton0.classList.remove("tool2ButtonON"):o!==gkey.x&&o!==gkey.m||tool2Array.redoButton1.classList.remove("tool2ButtonON"),o){case gkey.s:case gkey.j:case gkey.w:case gkey.u:case gkey.d:case gkey.h:case gkey.n:case gkey.c:case gkey.v:case gkey.b:case gkey.space:case gkey.shift:5===mainTool&&c1.clearRect(0,0,canvasWidth,canvasMaxHeight),mainTool=3,penSize=penSizeSet[penSizeIndex],penSizeCursorSelect(penSizeIndex),tool2CursorSelect(toolNumberArr[3]),changePenType(penCapType)}}else!1===afterPenReturnON&&(afterPenReturnON=!0)}),loadButtonInput.onchange=function(){const e=loadButtonInput.files[0],o=new FileReader;topmenuON=!1,activeFileMenuEnt.style.display="none",activeFileMenuEnt=null,console.log(""),o.onload=fileLoad,o.readAsDataURL(e)},doc.addEventListener("wheel",function(){clearTimeout(tool1CheckDelayTimer),tool1CheckDelayTimer=setTimeout(function(){checkGodPosition(),checkToolPosition()},150)}),window.addEventListener("scroll",function(){clearTimeout(tool1CheckDelayTimer),tool1CheckDelayTimer=setTimeout(function(){checkGodPosition(),checkToolPosition()},150)}),window.addEventListener("resize",function(){clearTimeout(tool1CheckDelayTimer),tool1CheckDelayTimer=setTimeout(function(){checkToolPosition(),checkGodPosition(),window.innerWidth!==lastInnerWidth&&(lastInnerWidth=window.innerWidth,godX=window.innerWidth/2-god.offsetWidth/2,setGodPosition())},150)}),window.ondragstart=function(){if(!1===fileNameON)return!1},tiny.onclick=function(){!0===(tinyFlag=!tinyFlag)?(canvas1.classList.add("tinyCursorON"),canvasPanel.classList.add("tinyCursorON"),tiny.style.opacity="1"):!1===tinyFlag&&(canvas1.classList.remove("tinyCursorON"),canvasPanel.classList.remove("tinyCursorON"),tiny.style.opacity="0.45")},titleFileName.addEventListener("click",function(e){!1===fileNameON&&(fileNameON=!0,e.target.setSelectionRange(0,e.target.value.length),doc.addEventListener("pointerdown",checkTitleFocus))}),titleFileName.addEventListener("change",function(e){titleFileName.offsetWidth<20&&(titleFileName.style.width="10px"),e.target.value&&""!==e.target.value||(titleFileName.value="Untitled"),titleFileNameClone.textContent=titleFileName.value;let o=titleFileNameClone.offsetWidth;o<10?o=10:o>300&&(o=300),titleFileName.style.width=o+"px",e.target.blur(),fileNameON=!1}),titleFileName.addEventListener("input",function(){titleFileNameClone.selectionStart=titleFileName.value.length,titleFileNameClone.textContent=titleFileName.value;let e=titleFileNameClone.offsetWidth;e<20?e=20:e>300&&(e=300),titleFileName.style.width=e+"px"}),startupSound.onended=function(){doc.getElementById("aboutImg").style.transform="",chCanvasPreview(390)},window.onbeforeunload=function(){return"quit?"};